/*
Built using Kango - Cross-browser extension framework.
http://kangoextensions.com/
*/
kango.Browser=function(){this.superclass.apply(this,arguments);this._lastTabId=0;this._tabs={};safari.application.addEventListener('beforeNavigate',kango.lang.bind(this._onBeforeNavigate,this),true);safari.application.addEventListener('navigate',kango.lang.bind(this._onNavigate,this),true);safari.application.addEventListener('activate',kango.lang.bind(this._onActivate,this),true);safari.application.addEventListener('open',kango.lang.bind(this._onOpen,this),true);safari.application.addEventListener('close',kango.lang.bind(this._onClose,this),true);};kango.Browser.prototype=kango.oop.extend(kango.BrowserBase,{_lastTabId:0,_tabs:null,_generateTabId:function(){return this._lastTabId++;},_registerTab:function(tab){var id=this._generateTabId();this._tabs[id]=tab;return id;},_unregisterTab:function(tab){var id=this._getTabId(tab);if(id!=-1){return delete this._tabs[id];}
return false;},_getTabId:function(tab){for(var id in this._tabs){if(this._tabs.hasOwnProperty(id)&&this._tabs[id]===tab){return id;}}
return-1;},_onOpen:function(event){if(event.target instanceof SafariBrowserTab){var tab=event.target;kango.browser.fireEvent(this.event.TabCreated,{target:this.getTab(tab),tabId:this._getTabId(tab)});}},_onClose:function(event){if(event.target instanceof SafariBrowserTab){var tab=event.target;this.fireEvent(this.event.TabRemoved,{tabId:this._getTabId(tab)});this._unregisterTab(tab);}},_onActivate:function(event){if(event.target instanceof SafariBrowserTab){var tab=event.target;kango.browser.fireEvent(this.event.TabChanged,{url:tab.url||'',title:tab.title||'',target:this.getTab(tab),tabId:this._getTabId(tab)});}},_onBeforeNavigate:function(event){this.fireEvent(this.event.BeforeNavigate,{url:event.url||'',target:this.getTab(event.target)});},_onNavigate:function(event){var tab=event.target;this.fireEvent(this.event.DocumentComplete,{url:tab.url||'',title:tab.title||'',target:this.getTab(tab)});},getTab:function(SafariBrowserTabObj){var tabId=this._getTabId(SafariBrowserTabObj);if(tabId==-1){tabId=this._registerTab(SafariBrowserTabObj);}
return new kango.BrowserTab(SafariBrowserTabObj,tabId);},getName:function(){return'safari';},windows:{getAll:function(callback){callback(kango.array.map(safari.application.browserWindows,function(item){return new kango.BrowserWindow(item);}));},getCurrent:function(callback){callback(new kango.BrowserWindow(safari.application.activeBrowserWindow));},create:function(details){safari.application.openBrowserWindow().activeTab.url=details.url;}},tabs:{getAll:function(callback){var result=[];var wins=safari.application.browserWindows;for(var i=0;i<wins.length;i++){var tabs=wins[i].tabs;for(var j=0;j<tabs.length;j++){result.push(kango.browser.getTab(tabs[j]));}}
callback(result);},getCurrent:function(callback){callback(kango.browser.getTab(safari.application.activeBrowserWindow.activeTab));},create:function(details){var focused=(typeof details.focused!='undefined')?details.focused:true;safari.application.activeBrowserWindow.openTab(focused?'foreground':'background').url=details.url;}}});kango.BrowserWindow=function(win){this._window=win;};kango.BrowserWindow.prototype=kango.oop.extend(kango.IBrowserWindow,{_window:null,getTabs:function(callback){callback(kango.array.map(this._window.tabs,function(item){return kango.browser.getTab(item);}));},getCurrentTab:function(callback){callback(kango.browser.getTab(this._window.activeTab));},isActive:function(){return(safari.application.activeBrowserWindow==this._window);}});kango.BrowserTab=function(tab,id){this._tab=tab;this._id=id;};kango.BrowserTab.prototype=kango.oop.extend(kango.IBrowserTab,{_id:null,_tab:null,getId:function(){return this._id;},getUrl:function(){return this._tab.url||'';},getTitle:function(){return this._tab.title||'';},getDOMWindow:function(){return null;},isActive:function(){return(this._tab==this._tab.browserWindow.activeTab);},navigate:function(url){this._tab.url=url;},dispatchMessage:function(name,data){if(typeof this._tab.page!='undefined'){this._tab.page.dispatchMessage(name,data);}}});kango.browser=new kango.Browser();